## 분산 시스템 기본요소
<hr/>

### DNS
<hr/>

* 도메인 네임서버의 약어로사람이 이해하기 쉬운 도메인 이름을 기계가 읽을수 있는 IP 주소로 변환하는 시스템
* 여러 네임서버와 리소스 레코드 데이터베이스, 단계쩍 캐싱, 계층적 구조를 이용해 도메인 이름을 IP 주소로 변환

#### 리소스 레코드

* DNS 데이터베이스, 매핑 정보를 리소스 레코드 라는 단위로 저장
* 종류
  * A 레코드: 호스트 이름을 IP 주소에 저장
  * NS 레코드: 도메인의 DNS 요청을 처리할수 있는 권한있는 네임서버를 매핑
  * CNAME 레코드: 도메인 이름에 별칭을 부여하여 각각 연결
  * MX 레코드: 메일서버 매핑

#### 네임서버(계층구조)

* DNS 를 응답하는 서버
* 로컬리졸버 -> 루트서버 -> 최상위 도메인 서버 -> 권한있는 네임서버 순서로 찾음
* 종류
  * 루트서버: 로컬 리졸버에서 `.com, .edu`같은 최상위 도메인의 네임서버 정보 관리
  * 최상위 도메인서버: 도메인의 권한있는 네임서버 IP 주소 보유 `google.com` 같은 정보 보유
  * 권한있는 네임서버: 최종 DNS, 웹 및 앱, 서버의 IP 주소 정보 제공
* 로컬 리졸버: IP 를 찾아주는 직접적인 중개자 역활, IPS 및 회사 네트워크의 로컬 DNS 서버가 리졸버 역활을 함

#### DNS 쿼리

* DNS 에 대응하는 IP 주소를 찾는 방법
* 종류
  * 반복적 쿼리
    * 사용자가 리졸버로 통해서 직접 물어보며 답을 찾아가는 방식
    * `사용자 -> 로컬리졸버 -> 루트서버 -> 로컬리졸버 -> 최상위 도메인 서버 -> 로컬리졸버 -> 권한있는 네임서버 -> 로컬리졸버 -> 사용자`
  * 재귀적 쿼리
    * 사용자가 리졸버를 통해 요청하면 상위 서버에서 모든 과정을 처리해서 알려줌
    * `사용자 -> 로컬리졸버 -> 루트서버-> 최상위 도메인 서버 -> 권한있는 네임서버 -> 최상위 도메인서버 -> 루트서버 -> 로컬리졸버 -> 사용자`

#### DNS 캐싱

* 자주 접근하는 리소스 레코드 임시저장
* 이점
  * DNS 계층 구조로 쿼리하지 않고 로컬에서 답을 제공하여 시간을 단축
  * 불필요한 쿼리를 줄여 트래픽 감소
* 사용처
  * 웹브라우저
  * 운영체제
  * 네트워크내 로컬네임서버
  * ISP 리졸버

#### DNS 의 중요요소

* 확장성
  * 루트서버, 최상위 도메인서버, 권한있는 네임서버로 구성된 계층적 구조로 높은 확장성 지닌다.
* 신뢰성
  * 브라우저, 운영체제, 로컬네트워크, ISP 리졸버 캐싱을 사용하여 사용자에게 정보를 빠르게 전달
* 안정성
  * 신뢰성 낮은 UDP 프로토콜을 사용하지만 응답없을시 재전송하여 보완, 안정적 수행가능
* 일관성
  * 강한 일관성 대신 캐싱된 레코드의 유효 기간설정과 점진적 업데이트로 최종일관성적용
  * 성능을우선하고 성능을 저하시키지 않는 수준에서 일관성 유지

### 로드밸런서
<hr/>

* 여러 서버, CPU, 하드드라이브, 네트워크 연결에 작업을 고르게 분배하여 효율적으로 사용하고 시스템이 과부하를 걸리지 않게 하는 장치
* 특징
  * 트래픽 분산으로 과부하 방지
  * 장애 발생 or 속도가 느려진 서버의 요청을 다른 정상 서버로 재전송하여 시스템 내구성 높임
  * 일부 서버가 작동하지 않더라도 나머지 서버가 요청을 처리하여 가용성 유지
  * 높은 트래픽 상황에서도 성능을 점진적 저하되도록하고 시스템은 계속 운영
  * 서버풀에 서버추가하면 수평 확장 가능 
* 로드밸런서 장점
  * 헬스체크를 이용하여 서버가 정상작동중인지 확인
  * TLS 연결을 종료하여 백엔드 서버의 안정성을 높일수 있음
  * 트래픽 패턴을 분석하여 효율적인 요청 분배 알고리즘을 이용하여 리소스 활용 극대화

#### 전역 로드밸런싱과 로컬 로드 밸런싱

* 로드밸런싱은 전역과 로컬 두가지 측면에서 이뤄짐
* 전역 서버 로드밸런싱은 다양한 지역에 있는 데이터 센터간 트래픽 분산
* 로컬 로드밸런싱은 개별 데이터 센터내에 자월 활용도를 높이는데 중점
* 전역 서버 로드 밸런싱은 사용자 위치, 데이터 센터 상태, 서버수 기반으로 적절한 데이터 센터로 전달
* 로컬 로드밸런싱은 전역 서버로드밸런싱에 상태와 용량 정보를 기반으로 어떤 데이터센터로 보낼지 결정

#### DNS 와 전역 로드밸런서

* DNS 도 어느정도 전역 서버 로드밸런싱 역활 수행
* 하나의 DNS 쿼리에 여러 IP 주소를 반환하고 각 클라이언트가 순차적으로 다른 IP 를 받도록 라운드 로빈 방식으로 트래픽 분산
* DNS 로드밸런싱 한계
  * ISP 별로 발생하는 트래픽 차이 반영 못함
  * 서버 다운시 감지 못함
* 캐시 TTL 을 짧게하여 설정하는 방식 사용
* DNS 로드 밸런싱 한계
  * DNS 패킷 크기가 512 바이트로 작다
  * 클라이언트가 IP 주소 직접 선택 불가능
  * 가장 가까운 서버를 결정할수 없다(지리적 위치기반 연결, 애니캐스팅으로 극복가능)
  * 장애시 TTL 값이 길때 캐싱으로 인해 복구가 느릴수도 있음
* 각 데이터 센터 내부에 로컬 로드밸런서를 두는게 더 효과적

#### 로드 밸런서 알고리즘

* 라운드로빈 스케줄링
  * 각 요청을 순차적으로 다음 서버에 할당
* 가중치 기반 라운드로빈
  * 서버 성능에 따라 가중치 부여하여 가중치가 높으면 더 많은 요청 받도록 설정
* 최소 연결 알고리즘
  * 현재 연결된 요청수가 가장 적은 서버에 새로운 요청 할당
  * 처리시간이 긴 요청이 포함되었을때 서버간 부하를 고르게 분배할수있음
  * 각 서버의 연결상태 파악하고 있어야함
* 최소 응답 시간 알고리즘
  * 응답시간이 가장 짧은 서버에 요청 할당
* IP 해시, URL 해시, 일광성 해시 알고리즘
  * IP, URL, 기반으로 특정서버에 할당
  * 특정 클라이언트나 URL 요청을 특정 서버로 라우팅 해야하는 경우 유용
* 동적 알고리즘
  * 서버의 현재 상태나 최근 상태 고려하여 요청 분배
  * 최소연결 알고리즘
  * 최소 응답 시간 알고리즘
* 정적 알고리즘
  * 서버 상태를 실시간으로 반영하지 않고 미리 설정된 서버 구성에 따라 요청 분배
  * 라운드로빈
  * 가중치 라운드 로빈
  * IP, URL, 일관성 해시
* 스테이트풀
  * 클라이언트와 백엔드 서버간 연결 상태 정보 저장
  * 확장성의 한계가 올수 있음
  * IP 해시, 쿠키/세션 스티키니스
* 스테이트리스
  * 클라이언트의 세션 상태를 따로 저장하지 않고 일관된 해싱 알고리즘을 사용하여 요청서버에 매핑
  * 확장성 유리하지만 인프라 변경시 안정성 낮음
  * 라운드 로빈

#### OSI 계층별 로드 밸런싱

* L7(응용 계층)
  * HTTP 기반 부하 분산
  * HTTP 헤더, URL 쿠키, 사용자 ID 등을 활용하여 분배
  * AWS ALB, Nginx
* L4(전송 계층)
  * TCP/UDP 기준으로 부하 분산
  * NAT 기반으로 패킷을 뜯지 않고 그대로 부하분산
  * AWS NLB, LVS
* L3(네트워크 계층))
  * 라우터가 IP 주소를 보고 최적경로 찾음 똑같은 거리가 1개이상일시 패킷을 나눠서 보냄
  * 라우터, ECMP
* L2 (데이터 링크 계층)
  * 대역폭 확장 및 선 하나가 끊어졌을 때 대비, LAN 포트 2개에 선을 꽂고 하나로 묶는다.
* OSI 계층이 올라갈수록(L4 -> L7) 로드밸런서는 더많은 기능을 할수있지만 느려짐

#### 로드 밸런서 구현

* 하드웨어 로드밸런서
  * 성능이 뛰어나고 가격이 비쌈
  * 특정 벤더에 종속되고 유지보수가 어려움
* 소프트웨어 로드 밸런서
  * 유연하다
  * 괄리자가 특정조건에 맞게 코드로 부하분산 가능
* 클라우드 로드밸런서
  * 사용량에 따라 비용을 지불한다
  * 글로벌 트래픽 관리도 가능
  * 확장성, 모니터링 기능이 좋음

#### 애플리케이션 게이트웨이

* 클라이언트와 백엔드 서비스 사이에서 프록시 역활을 하여 라우팅, 보안강화, 성능 가속등 지원
* 기능
  * 고급 요청 라우팅
    * 호스트이름, 경로, 헤더, 요청보낸 IP 등 다양한 조건에 적합한 백엔드 서비스로 요청 전달
  * 보안
    * 공통 보안 기능을 중앙에서 관리하여 모든 백엔드 서비스 보호
    * 인증, 접근제어 TLS 종료 등 WAF 를 통합하여 보안 강화 가능
  * 가속화, 오프로딩
    * 성능 향상을 위해 키싱. 압축등 기능 수행
    * CPU 부하가 많이 걸리는 작업을 시스템 엣지에서 대신 처리하게 함으로 백엔드서비스가 붇마을 덜수 있음
  * 모니터링
    * 로그, 메트릭, 트레이스를 통합하여 수집
  * 적응성
    * 요청과 응답을 조정하여 백엔드 서비스의 변화하는 기능을 유연하게 처리
    * 레거시와 프로토콜 맞추기

#### 마이크로 서비스 아키텍쳐

* 단일 서비스 여러개로 구성된 거대한 시스템으로 각 서비스는 독립적으로 개발 배포
* 마이크로 서비스에서 애플리케이션 게이트웨이 의미
  * 여러 마이크로 서비스를 하나의 논리적 API 로 묶어 클라이언트에 제공(횡단 관심사)
  * 서비스 디스커버리와 동적 요청 라우팅을 통해 백엔드 서비스 연결하여 로드밸런싱 적용
  * 보안, 모니터링 안정성등 중앙에서 처리하여 코드 중복 제거
  * 백엔드 서비스와 상관없이 게이트웨이 새버전 독립적으로 배포
  * 서비스를 독립적으로 개발하고 확장할수있어 개발속도 높인다

#### 클라우드 네이티브 애플리케이션 게이트웨이

* AWS
* Azure
* GCP
* 쿠버네티스 환경

#### 온프레미스 옵션

* Kong
* Tyk
* Nginx
* HAProxy