
## 컨테이너 사용법

-----------------------

### 컨테이너와 호스트 간 파일 복사

* 파일복사는 컨테이너 -> 호스트, 호스트 -> 컨테이너 양방향 모두 가능하다
* `docker cp 호스트_경로 컨테이너_이름:컨테이너 경로`커맨드로 호스트 -> 컨테이너로 복사할수 있다.
* `docker cp 컨테이너_이름:컨테이너_경로 호스트_경로`커맨드로 컨테이너 -> 호스트로 복사할수 있다.
* `docker cp 원본_경로 복사할_경로`커맨드 이다.
* 호스트 경로 예

|항목|              값               |
|:--:|:----------------------------:|
|문서폴더(윈도우)| C:\Users\사용자이름\Documents/파일명 |
|문서폴더(맥)|  /Users/사용자이름/Documents/파일명  |
|문서폴더(리눅스)|       /home/사용자이름/파일명        |
|컨테이너 경로|/usr/local/apache2/htdocs/파일명|

* `docker cp /Users/ijisu/Desktop/index.html apa000ex19:/usr/local/apache2/htdocs/`
* `docker cp apa000ex19:/usr/local/apache2/htdocs/index.html /Users/ijisu/Desktop/`

### 볼륨 마운트

* 볼륨을 마운트 하면 컨테이너의 일부를 호스트 컴퓨터의 일부와 같이 다룰수 있다.
* 볼륨은 스토리지의 한 영역을 분할한것
* 마운트는 연결하다의 의미로 컨테이너의 디렉터리를 호스트의 디렉터리에 연결하는 것
* 실제로 컨테이너를 사용하려면 스토리지 영역을 마운트 해야한다. 데이터가 스토리지에 있기 때문
* data persistence(데이터의 영속성)을 위해 사용한다.
* 도커에서 스토리지의 마운트는 두종류가 있다
  * 볼륨 마운트
  * 바인드 마운트

#### 볼륨 마운트

* 볼륨 마운트는 도커 엔진이 관리하는 영역 내에 만들어진 볼륨을 컨테이너에 디스크 형태로 마운트 한다.
* 이름만으로 관리가 가능하므로 다루기 쉽지만 볼륨에 비해 직접 조작하기 어려우므로 임시 목적의 사용이나 자주쓰지는 않지만 지우면 안되는 파일을 두는 목적으로 사용된다.

#### 바인드 마운트

* 바인드 마운트는 도커가 설치된 컴퓨터의 문서 폴더 똔느 바탕화면 폴더 등 도커 엔진에서 관리하지 않는 영역의 기존 디렉터리를 컨테이너에 마운트 하는 방식이다.
* 디렉터리가 아닌 파일 단위로도 마운트 가능하다.
* 폴더 속에 파일을 직접 두거나 열어 볼수 있기 때문에 자주 사용하는 파일을 두는 데 사용한다.

#### 차이점

* 두가지 마운트 방식의 차이점은 세가지이다.
  * 간단한지
  * 호스트 컴퓨터 에서 파일을 다룰 필요가 있는지
  * 환경의 의존성을 배제해야 하는지

#### 볼륨마운트

* 볼륨 마운트는 도커 엔진의 관리하에 있으므로 사용자 파일 위치를 신경쓸 필요가 없다
* 운영체제에 따라 명령어가 달라지는 등의 의존성 문제도 일어나지 않는다.
* 볼륨 마운트는 익숙해지면 쉽게 사용할수 있다.
* 도커 제작사에서는 볼륨 마운트 사용을 권장한다.
* 하지만 볼륨 마운트는 도커 컨테이너를 경유하지 않고 직접 볼륨에 접근할 방법이 없다.
* 억지로 볼륨을 수정하려고 하면 볼륨 자체가 깨질 우려가 있기 때문에 백업을 하려면 복잡한 절차가 필요하다.

#### 바인드 마운트

* 바인드 마운트는 도커가 관리하지 않는 영역 어디라도 파일을 둘수 있으며 기존과 동일한 방식으로 파일을 사용할수 있으므로 다른 소프트 웨어를 사용해 쉽게 편집할수 있다.
* 도커 엔진과 무관하게 파일을 다룰수 있다.
* 파일을 자주 편집해야 하는 경우 바인드 마운트를 사용해야 한다.

* 파일을 직접 편집해야 한다면 바인트 마운트 그렇지 않다면 볼륨마운트를 사용해야 한다.

|항목|볼륨마운트|바인드 마운트|
|:--:|:-------:|:----------:|
|스토리지 영역|볼륨|디렉터리 또는 파일|
|물리적 위치|도커 엔진의 관리 영역|어디든지 가능|
|마운트 절차|볼륨을 생성한 후 마운트|기존 파일 또는 폴더를 마운트|
|내용편집|도커 컨테이너를 통해서|일반적인 파일과 같이|
|백업|절차가 복잡함|일반적인 파일과 같이|

* 임시메모리 마운트
* 디스크가 아닌 주 메모리 영역을 마운트 하다.
* 디스크보다 훨씬 빠른 속도록 읽고 쓰기가 가능하다
* 접근 속도를 높일 목적으로 사용하지만 도커 엔진이 정지 되거나 호스트가 재부팅하면 소멸한다.

#### 스토리지 영역을 마운트하는 커맨드

* 스토리지 마운트는 어느 마운트 방식이든 run 커맨드의 옵션 형태로 지정한다.
* 마운트 하려는 스토리지의 경로가 컨테이너 속 특정 경로와 연결되도록 설정하는 형태
* 스토리지 마운트를 하려면 먼저 마운트될 스토리지를 생성해야 한다.
* `docker volume create 볼륨_이름`으로 볼륨을 생성한다.
* `docker volume rm 볼륨_이름`으로 삭제한다.

|커맨드|내용|생략형|주요옵션|
|:--:|:--:|:--:|:--:|
|create|볼륨을 생성|X|거의 사용 X|
|inspect|볼륨의 상세 정보를 확인|X|거의 사용 X|
|ls|볼륨 목록을 확인|X|거의 사용 X|
|prune|사용하지 않는 볼륨을 삭제|X|거의 사용 X|
|rm|볼륨을 삭제|X|거의 사용 X|

* 스토리지 마운트 커맨드는 -v 옵션 뒤에 '스토리지 실제 경로' 또는 '볼륨이름', '컨테이너 마운트 경로' 순서대로 기재한다.
* 바인드 마운트는 볼륨을 마운트 하지 않지만 볼륨 마운트와 마찬가지로 -v 옵션을 사용한다.
* `docker run (생략) -v 스토리지_실제_경로:컨테이너_마운트_경로 (생략)` : 바인드 마운트 커맨드 예
* `docker run (생략) -v 볼륨_이름:컨테이너_마운트_경로 (생략)` : 볼륨 마운트 커맨드 예
* `docker run --name apa000ex20 -d -p 8090:80 -v /Users/ijisu/Desktop/apa_folder:/usr/local/apache2/httpdocs httpd`

#### 볼륨 마운트 커맨드

* `docker volume create apa000vol1`
* `docker volume inspect apa000vol1`
* `docker volume rm apa000vol1`
* `-v apa000vol1:/usr/local/apache2/httpdocs`
* `docker run --name apa000ex21 -d -p 8091:80 -v apa000vol1:/usr/local/apache2/htdocs httpd`
* `docker volume inspect apa000vol1`
```
  [
    {
        "CreatedAt": "2023-09-23T19:11:38Z",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/apa000vol1/_data",
        "Name": "apa000vol1",
        "Options": null,
        "Scope": "local"
    }
]
```
* `docker container inspect apa000ex21`
```
[
    .....
        "Mounts": [
            {
                "Type": "volume",
                "Name": "apa000vol1",
                "Source": "/var/lib/docker/volumes/apa000vol1/_data",
                "Destination": "/usr/local/apache2/htdocs",
                "Driver": "local",
                "Mode": "z",
                "RW": true,
                "Propagation": ""
            }
        ],
        ....
```
* `docker volume rm apa000vol1`

#### 볼륨 백업

* 바인드 마운트는 파일 복사만드로 백업이 끝난다.
* 볼륨 마운트는 백업이 까다로우므로 벼로듸 리눈스 컨테이너를 연결해 볼륨의 내용을 압축해 저장한다.
* 컨테이너 명령과 tar 명령어로 백업을 수행한다.
* `docker run --rm -v 볼륨명:/moto -v 백업_저장_폴더명:/target busybox tar cvzf /sake/백업파일이름.tar.gz -C /source`
* `docker rum --rm (옵션) busybox (인자)`
* 스토리지 영역을 두개 마운트 한다.
* 첫번쨰는 볼륨을 busybox 컨테이너에 마운트 한다.
* 두번째는 백업된 데이터를 저장할 호스트의 폴더를 마찬가지로 busybox 컨테이너에 마운트 한다. 두번째 마운트는 바인드 마운트 이다.
* /source 에 마운트된 볼륨의 내용을 /target 에 복사해 컨테이너 외부에 데이터를 저장하기 위해서다.
* `docker run --rm -v apa000vol1:/source -v C:/Users/사용자면/Documents:/target busybox tar czvf /target/backup_app.tar.gz -C /source .`
* `docker run --rm -v apa000vol2:/source -v C:/Users/사용자면/Documents:/target busybox tar czvf /target/backup_app.tar.gz -C /source .`

### 컨테이너로 이미지 만들기

* 이미 존재하는 컨테이너로 이미지를 만들수 있다.
* 이미지를 만드는 방법 두가지
  * 커밋 커맨드로 기존 컨테이너 이미지 변환
  * Dockerfile 스크립트로 이미지화
* `docker commit 컨테이너_이름 새로운_이미지_이름` : 커밋 커맨드
* 도커 파일은 도커 이미지를 만드는것밖에 할수 있는게 없다.
* `docker build -t 생성할_이미지_이름 재료_폴더_경로` : 도커파일 자주 사용되는 커맨드
```
// 도커파일 명령어
FROM 이미지_이름
COPY 원본_경로 대상_경로
RUN 리눅스_명령어
```
|인스트럭션|                     내용                     |
|:--:|:------------------------------------------:|
|FROM|               토대가 되는 이미지를 지정               |
|ADD|              이미지에 파일이나 폴더를 추가              |
|COPY|              이미지에 파일이나 폴더를 추가              |
|RUN|              이미지를 만들때 실행할 명령어              |
|CMD|             컨테이너를 실행할때 실행할 명령어             |
|ONBUILD|      이 이미지를 기반으로 다른 이미지를 만들때 실행할 명령어       |
|EXPOSE|            컨테이너가 실행될때 오픈할 포트 번호            |
|VOLUME|             퍼시스턴스시 데이터를 저장할 경로             |
|ENV|                  환경변수를 설정                  |
|WORKDIR|             명령어를 실행할 디렉터리를 설정              |
|SHHELL|               빌드시 사용할 쉘을 변경                |
|LABEL|               이미지에 메타데이터를 추가               |
|USER|             컨테이너를 실행할 사용자를 설정              |
|ARG|   docker build 커맨드를 사용할때 입력받을수 있는 인자 선언    |
|STOPSIGNAL| 컨테이너를 중지할때 커테이너 안에서 실행중인 프로그램에 전달되는 시그널 변경 |
|HEALTHCHECK| 컨테이너의 상태를 점검하는 명령어를 설정 |

* `docker commit apa000ex22 ex22_original1` : 커밋 커맨드 예
```
FROM httpd
COPY index.html /usr/local/apache2/htdocs
```
* `docker build -t ex22_original2 /Users/ijisu/Desktop/apa_folder` : 도커파일 커맨드 예

### 컨테이너 개조

* 컨테이너 개조란 컨테이너를 실행할때 컨테이너의 설정을 변경하는 것
* 컨테이너 개조 방법 두가지
  * 파일복사와 마운트를 이용한 방법
  * 컨테이너에서 리눅스 명령어를 실행하는 방법
* 컨테이너에서 리눅스 명령어를 실행하려면 리눅스에 쉘이 설치되어 있어야 한다.
* 대부분의 컨테이너에는 bash 가 설치돼 있다.
* 컨테이너를 아무 설정없이 실행하면 bash 가 동작하지 않는 상태로 실행되는데 bash 를 실행해 명령을 입력받을수 있는 상태로 만들어야 한다.
* `docker exec or run (옵션) 컨테이너_이름 /bin/bash` : 컨테이너에서 bash 실행
* exec 커맨드는 컨테이너가 실행중인 상태에서 run 을 사용할수 없을때 사용할수 있다.
* bash 가 실행되면 쉘에 입력된 명령은 도커엔진이 아니라 해당 컨테이너로 전달되는데 도커엔진과 컨테이너는 부모-자식 관계이다.
* bash 를 통해 컨테이너 내부를 조작하는 동안에는 도커 명령을 사용할수 없다.
* `exit`명령어로 컨테이너에서 나오면 도커엔진에 명령을 내릴수 있다.

#### 도커 구조, 엔진을 통해야 하는 명령과 컨테이너 안에서 실행해야 하는 명령

* 도커 엔진을 통해서 하는 명령은 도커 엔진 자체의 시작, 종료, 네트워크, 디스크 설정, 실행중인 컨테이너 확인등 컨테이너 전체 관리에 대한것이다.
* 컨테이너 내부에서 실행하는 명령은 컨테이너 속에 새로운 소프트웨어 추가, 실행, 종료, 설정변경, 컨테이너 안과 밖의 파일 복사, 이동, 삭제 작업이다.
* 도커와 컨테이너는 별개의 언어를 사용한다.
* 컨테이너에 들어있는 운영체제에 따라 컨테이너 내부에서 사용하는 명령어가 달라진다.
* 도커에서는 공식적으로 데비안 계열을 추천한다.

### 도커 허브 등록 및 로그인

* 도커 이미지 내려받기는 도커 허브에서 내려받은 것이다.
* 직접 만든 이미지도 도커 허브에 올릴수 있고 비공개로 사용하는 도커 허브 같은 장소도 만들수 있다.
* 이미지를 배포하는 장소는 도커 레지스트리 라고 한다.
* 도커 허브는 도커 제작사에서 운영하는 공식 도커 레지스트리를 말한다.
* 리포지토리는 레지스트리를 구성하는 단위 이다.
* 도커 허브에서는 리포지토리가 각각 ID 를 갖게 돼있다.
* 도커허브는 각각의 회사나 개인이 가진 레지스트리가 여럿 모인 형태이다.

#### 태그와 이미지 업로드

* 도커허브에 업로드 하려면 이미지에 태그를 부여해야 한다.
* 태그는 `레지스트리_주소(도커 허브 ID)/리포지토리_이름:버전`의 형식이다.
* `docker tag 원래_이미지_이름 레지스트리_주소/리포지토리_이름:버전`의 형태로 이미지 태그를 부여해 복제할수 있다.
* `docker push 레지스트리_주소/리포지토리_이름:버전`의 형태로 이미지를 업로드 할수 있다.
* push 커맨드로 리포지토리를 만들면 공개상태이다.

#### 레지스트리 만들기

* `docker run -d -p 5000:5000 registry`로 레지스트리를 만들수 있다.