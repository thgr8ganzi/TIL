
## 쿠버네티스

----------------

### 쿠버네티스란

* 컨테이너 오케스트레이션 도구의 일종
  * 컨테이너 오케스트레이션이란 시스템 전체를 통괄하고 여러개의 컨테이너를 관리하는 일을 말한다.
* 쿠버네티스를 k8s 라고도 부른다. k 와 s 사이의 8글자가 있다는 의미
* 쿠버네티스를 일반적인 프로그래머가 사용할 일은 많지 않다. 대규모 시스템을 관리할일이 많지 않기 때문
* 다만 쿠버네티스로 할수 있는 일이 많기 때문에 알아두면 좋다.

#### 쿠버네티스는 여러대의 컨테이너가 여러대의 물리적 서버에 걸쳐 실행되는것을 전제로 한다.

* 쿠버네티스는 번거로운 컨테이너 생성이나 관리의 수고를 덜어준다.
* 도커 컴포즈 파일과 비슷한 정의파일(매니페스트 파일)작성으로 모든 물리적 서버에 컨테이너를 생성하고 관리해준다.

### 마스터 노드와 워커 노드

* 쿠버네티스의 전체적 제어를 담당하는 마스터 노드와 실제 동작을 담당하는 워커노드 두가지 유형의 노드로 구성된다.
* 노드는 물리적 서버를 의미한다.
* 마스터 노드
  * 마스터 노드에서 컨테이너를 실행하지 않으며 워커 노드에서 실행되는 컨테이너를 관리하는 역활을 한다.
  * 도커 엔진 같은 컨테이너 엔진도 설치되지 않는다.
* 워커노드
  * 실제 서버에 해당하는 부분으로 컨테이너가 실제 동작하는 서버다
  * 컨테이너가 동작해야 하므로 컨테이너 엔진이 설치돼야 한다.
* 마스터 노드와 워커노드로 구성된 쿠버네티스 시스템을 클러스터 라고 한다.
* 클러스터는 마스터 노드에 설정된 내용에 따라 워커 노드가 관리되며 자율적으로 동작한다.
* 관리자는 마스터 노드 설정후 가끔 조정할뿐 직접 워커노드를 관리하는 일도 드물다.

#### 쿠버네티스 설치

* 쿠버네티스는 도커 엔진등의 컨테이너 엔진과 별개의 소프트웨어다.
* 쿠버네티스 소프트웨어와 CNI(가상 네트워크 드라이버)를 설치해야 한다.
* 또한 마스터 노드에는 컨테이너 상태 관리를 위해 etcd 라는 데이터 베이스가 설치된다.
* 또 마스터 노드를 설정하는 관리자의 컴퓨터에는 kubectl 을 설치한다.
* kubectl 을 설치해야 마스터 노드에 로그인해 초기 설정을 진행하거나 추후 조정이 가능하다.

#### 컨트롤 플레인(제어판)과 kube-let

* 마스터 노드는 컨트롤 플레인을 통해 워커 노드를 관리한다.
* etcd 외에는 쿠버네티스에 포함돼 있으므로 굳이 설치할 필요는 없다.

* 마스터 노드측 컨트롤 플레인 구성

| 항목  |                    내용                     |
|:---:|:-----------------------------------------:|
| kube-apiserver  | 외부와 통신하는 프로세스, kubectl 로부터 명령을 전달받아 실행한다. |
| kube-controller-manager  |            컨트롤러를 통합 관리, 실행한다.             |
| kube-scheduler  |             파드를 워커 노드에 할당한다.              |
|cloud-controller-manager|         클라우드 서비스와 연동해 서비스를 생성한다.          |
|etcd|클러스터 관련 정보 전반을 관리하는 데이터베이스|

* 워커 노드에서는 kube-let 과 kube-proxy 가 동작한다.
* kube-let 은 마스터 노드의 kube-scgeduler 와 연동하며 워커노드에 컨테이너 또는 볼룸을 배치하고 실행한다.
* 따로 설치할 필요는 없다.

* 워커 노드 구성

|항목|                                                    내용                                                     |
|:---:|:---------------------------------------------------------------------------------------------------------:|
|kube-let| 마스터 노드에 있는 kube-scheduler 와 연동하며 워커노드에 파드를 배치하고 실행한다. 또 실행중인 파드의 상태를 정기적으로 모니터링 하며 kube-scgeduler 에 보고한다. |
|kube-proxy|                                             네트워크 통신의 라우팅 메커니즘                                             |

#### 쿠버네티스는 항상 바람직한 상태를 유지한다.

* 쿠버네티스도 컨테이너를 생성하거나 삭제할수 있지만 일일이 명령어를 입력하는 방식을 사용하지 않는다.
* YAML 파일에 정의하고 자동으로 컨테이너를 생성하거나 삭제하면서 이상태를 만들고 유지하는게 쿠버네티스의 기본적 아이디어이다.
* 도커 컴포즈는 옵션을 지정해 수동으로 컨테이너수를 바꿀수 있지만 모니터링 기능이 없어서 컨테이너를 만들때 외에는 관여하지 않는다.
* 쿠버네티스는 상태를 유지하는 기능이 있다.
* 또한 물리적인 서버에 걸쳐 시스템을 구성할수 있고 별개의 데이터 센터에 위치한 서버끼리로 시스템을 구성할수 있다.
* 컨테이너가 망가졌다면 쿠버네티스가 알아서 망가진 컨테이너를 삭제하고 새 컨테이너로 대체할수 있다.

#### 쿠버네티스를 사용하는 시스템에서 컨테이너 삭제

* 쿠버네티스는 자동으로 상태를 유지하는것이므로 컨테이너를 삭제하고 싶다면 설정파일에서 수정해야 한다.
* 도커 명령어로 삭제 가능하나 쿠버네티스가 탐지하고 다시 보충한다.
* 사람이 개입해서 컨테이너를 삭제해서는 안된다.
* 쿠버네티스 정의 파일(매니페스트)이 데이터 베이스로 관리 된다는게 도커 컴포즈와 다른점이다.

### 쿠버네티스의 구성관 관련 용어

#### 파드

* 컨테이너와 볼륨을 함께 묶은것으로 기본적으로 파드 하나가 컨테이너 하나지만 컨테이너가 여러개인 파드도 있을수 있다.
* 컨테이너도 여러개로 구성하는것이 기본이다.
* 파드에 포함되는 볼륨은 기본적으로 함께 파드에 포함되는 컨테이너가 정보를 공유하기 위한것으로 볼륨이 없는 경우도 많다.

#### 서비스

* 파드를 모은것이 서비스 이다.
* 서비스가 관리하는 파드는 모두 기본적으로 동일한 구성을 갖는다.
* 파드가 여러개의 워커노드에 걸쳐 동작하더라도 이들을 모두 관리한다.
* 로드밸런서의 역활을 한다.
* 각 서비스는 자동적으로 고정된 IP 주소를 받으면 이 IP 주소를 통해 들어오는 통신을 처리한다.
* 내부적으로 여러개의 파드가 있어도 밖에서는 하나의 IP 주소만 볼수있으며 이주소로 접근하면 서비스가 통신을 적절히 분배해주는 구조다.
* 서비스가 분배하는 통신은 한 워커노드 안으로 국한되므로 여러 워커 노드간의 분배는 실제 로드밸런서, 인그레스가 담당한다.

#### 디플로이먼트와 레플리카 세트

* 레플리카세트는 파드의 수를 관리한다.
* 정의파일에 정의된 파드수와 맞춘다.
* 레플리카 세트가 관리하는 동일한 구성의 파드를 레플리카 라고 부른다.
* 파드의 수를 조정하는 것을 레플리카 수를 조정한다, 파드수를 경정하는것도 레플리카 수를 경정한다고 표현한다.
* 레플리카 세트는 원하는대로 다루기가 어려워 디플로이먼트와 함께 쓰인다.
* 디플로이먼트란 파드의 디플로이를 관리하는 요소로 파드가 사용하는 이미지등 파드에 대한 정보를 갖고있다.
* 디플로이먼트는 레플리카 세트를 관리한다.

#### 리소스

* 파드, 서비스, 디플로이먼트, 레플리카세트 등을 리소스라고 한다.

* 주요 쿠버네티스 리소스

|   리소스 이름    |         내용          |
|:-----------:|:-------------------:|
|     pod     |   컨테이너와 볼륨을 묶은 단위   |
| podtemplate |    배포시 파드의 형틀 역활    |
|replicationcontroller|     레플리케이션을 제어      |
|resourcequota|    리소스 사용량 제한 설정    |
|secret|  비밀번호 등의 중요 정보를 저장  |
|serviceaccount|  리소스를 다루는 사용자를 관리   |
|service|     파드에 요청을 배분      |
|daemonset| 워커 노드마다 하나의 파드를 생성  |
|replicaset|      파드의 수를 관리      |
|statefulset| 파드의 배포를 상태를 유지하며 관리 |
|cronjob|    주기적으로 파드를 실행     |
|job|     파드를 한번더 실행      |

* 파드나 서비스, 레플리카, 디플로이먼트를 각각 파드 오브젝트, 서비스오브젝트라 부르기도 한다.
* 이는 리소스가 마스터 노드에 위치한 데이터베이스 etcd 에 등록된 상태에서 오브젝트라는 용어를 사용한다.
* 이렇게 실제로 생성된것을 인스턴스라 한다.
* 정리하자면 데이터 베이스에 오브젝트로 등록된 정보를 기초로 인스턴스를 실제로 생성하는것.

### 쿠버네티스 설치 및 사용법

* 쿠버네티스는 클라우드 네이티브 컴퓨팅 재단(CNCF) 이라는 단체에서 제정한 표준이다.
* 원래 구글에서 개발되었지만 CNCF 를 조직하고 이 재단에 쿠버네티스를 기부하였다.

#### 쿠버네티스 선택

* 원조 쿠버네티스를 채택하는것은 흔하지만 구축은 어렵다.
* 클라우드 컴퓨팅 서비스를 사용해 구축하는 경우가 많다.
* AWS 에서 EC2, Fargate 를 워커노드로 사용하고 EKS 를 마스터 노드로 사용해 관리한다.
* 도커 데스크톱에서 간단한 설정으로 etcd, CNI 를 설치할 필요없이 간단히 사용할수 있다.
* 리눅스 에서는 Minikube 를 사용해 쿠버네티스를 사용할수 있다.

### 매니페스트 파일 작성

* 쿠버네티스는 매니패스트 파일에 기재된 내용에 따라 파드를 생성한다.
* 그 내용은 데이터베이스(etcd)에 등록되어 관리된다.
* 매니페스트 파일은 YAML 형식으로 작성한다.
* 매니페스트 파일은 리소스(파드, 서비스, 디플로이먼트 등)단위로 작성된다.
* 파드 항목은 파드만을 만들때 사용하고 파드 항목에는 작성하지 않는다.
* 개수를 유지하는 기능은 디플로이먼트나 레플리카세트에서 담당한다.
* 디플로이먼트 항목을 작성하면 레플리카세트나 파드도 함께 작성된다.
* 매니페스트 파일은 리소스 단위로 작성하며 여러개의 리소스를 하나의 파일에 작성할수 있다.
* 매니페스트 파일은 컴포즈 파일과 마찬가지로 주항목이 있는다.
```
apiVersion:API 그룹 및 버전
kind: 리소스 유형
metadata: 메타데이터
spec: 리소스 내용
```
* 리소스 API 그룹 및 리소스 유형

|리소스|API 그룹/버전|리소스 유형|
|:---:|:---:|:---:|
|파드|core/v1|Pod|
|서비스|core/v1|Service|
|디플로이먼트|apps/v1|Deployment|
|레플리카세트|apps/v1|ReplicaSet|

* 주요 메타데이터

|항목|             내용             |
|:---:|:--------------------------:|
|name|   리소스 이름, 문자열로된 유일한 식별자    |
|namespace|    리소스를 세분화한 DNS 호환 레이블    |
|uid|   리소스의 고유 식별자, 자동으로 생성됨    |
|resourceVersion|     리소스의 버전, 자동으로 생성됨      |
|generation|       생성 순서를 나타내는 번호       |
|creationTimestamp|           생성 시간            |
|deletionTimestamp|           삭제 시간            |
|labels|   리소스에 붙이는 레이블, 키와 값의 쌍    |
|annotations| 리소스에 설정할 값, 선택 대상은 되지 못한다. |

* 파드나 서비스같은 리소스에 원하는 레이블을 붙일수 있다.
* 레이블을 부여하면 셀렉터 기능을 사용해 특정 레이블이 부여된 파드만을 배포할수 있다.

#### 메타데이터 스펙 작성방법 - 파드

* 파드의 중항목은 세개이고 메타데이터 아래로 name 과 labels 스펙 아래로 containers 가 있다.
```
metadata:
  name: 파드 이름
  labels: 레이블
spec:
  containers: 컨테이너 구성
    - name: 컨테이너 이름
      image: 이미지 이름
      ports: 포트 설정
```

#### 메타데이터 스펙 작성방법 - 디플로이먼트

```
apiVersion:
kind:
metadata:
  name: 디플로이먼트 이름
spec:
  selector: 셀렉터 설정
    matchLabels: 셀렉터가 선택할 관리 대상 레이블
  replicas: 레플리카 수
  template: 템플릿
    metadata: 파드의 메타데이터를 기재
    spec: 파드의 스펙을 기재
```
* 디플로이먼트는 파드를 관리하는 리소스이다.
* 템플릿 형태로 파드 설정을 기재한다.
* 셀렉터는 디플로이먼트가 관리하는 파드를 지정한다.
* 레플리카는 파드수를 몇개로 유지할지 설정한다.
* 생성할 파드의 정보를 템플릿에 기재한다. 파드 이름은 설정하지 않는다.

#### 메타데이터 스펙 작성방법 - 서비스

* 서비스는 파드로 들어오는 요청을 관리하는것으로 통신과 관련된것
```
apiVersion:
kind:
metadata:
  name: 서비스 이름
spec:
  type: 서비스 유형
  port: 포트 설정
  - port: 서비스 포트
    targetPort: 파드 포트
    protocol: 프로토콜
    nodePort: 워커 노드 포트
  selector: 셀렉터 설정
```
* type 은 서비스의 종류로 외부로부터 서비스에 어떤 유형의 IP 주소로 접근할지 설정한다.

|유형|               내용               |
|:---:|:------------------------------:|
|ClusterIP| 클러스터 내부에서만 접근 가능한 IP 주소를 할당한다. |
|NodePort|   워커 노드의 IP 를 통해 서비스에 접근하도록함   |
|LoadBalancer|   로드밸런서 IP 를 사용해 서비스에 접근하도록함   |
|ExternalName|   파드에서 서비스를 통해 외부로 나가기 위한 설정   |

* port 는 서비스가 사용할 포트를 설정한다.

|항목|             내용             |
|:---:|:--------------------------:|
|port|   서비스 포트    |
|targetPort|    파드 포트    |
|protocol|   프로토콜    |
|nodePort|   워커 노드 포트    |

* selector 는 서비스가 관리하는 파드를 지정한다.
* 디폴로이먼트에는 matchLabels 가 있지만 서비스에는 selector 가 있다.

### 쿠버네티스 명령어

* 쿠버네티스는 kubectl 이라는 명령어를 사용해 관리한다.
* 쿠버네티스는 도커엔진과 별개의 소프트웨어로 명령이 다르다
* `kubectl 커맨드 옵션`형식이다.

|커맨드|               설명                |
|:---:|:-------------------------------:|
|create|             리소스 생성              |
|edit|             리소스 수정              |
|delete|             리소스 삭제              |
|get|             리소스 조회              |
|set|            리소스 값 설정             |
|apply|          리소스 변경 사항 반영           |
|describe|            리소스 상세 조회            |
|diff|          리소스 변경 사항 조회           |
|expose| 여러 파드에 부하를 분산하는 새로운 서비스 오브젝트 성생 |
|scale|         리소스의 레플리카 수를 변경         |
|autoscale|      리소스의 레플리카 수를 자동으로 변경       |
|rollout|            롤 아웃을 수행             |
|exec|           파드에 명령을 전달            |
|run|        컨테이너에서 명령을 한번 실행         |
|attach|             파드에 접속              |
|cp|          컨테이너에 파일을 복사           |
|logs|           파드의 로그를 확인            |
|cluster-info|           클러스터 정보 확인            |
|top|    CPU, 메로리, 스토리지등 시스템 자원 확인    |


