## Postgresql 아키텍처 개요

<img src="https://private-user-images.githubusercontent.com/91363333/383144228-94057114-93bb-443b-9baa-93fac6a5284d.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzA4MDk5MjYsIm5iZiI6MTczMDgwOTYyNiwicGF0aCI6Ii85MTM2MzMzMy8zODMxNDQyMjgtOTQwNTcxMTQtOTNiYi00NDNiLTliYWEtOTNmYWM2YTUyODRkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDExMDUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMTA1VDEyMjcwNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWFmZjk0ZmVhNGE5NzQxOWQwOTkwMGYzZjJjNzkzYjcyNjI0Yjk0NmVmYjQ0Y2U2ZjA4NzQwN2UwNDkwZjBmNDcmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.0duxQUCCFmzss9hdPqm7JLTCXUKEnmHRFQOe9vQptok" alt="Postgresql1" style="max-width: 100%;">

* PostgreSQL 물리구조는 공유메모리, 백그라운드 프로세스, 데이터 파일로 구성
* shared Memory
  * shared buffer 와 WAL 버퍼로 구성
  * shared buffer
    * disk io 를 초소화 시킨다.
    * 수십, 수백 GB 버퍼를 빠르게 액세스
    * 많은 사용자가 동시에 접근할대 경합 최소화
    * 자주 사용되는 블록은 오랫동안 버퍼내에 있어야함
  * WAL 버퍼
    * 데이터베이스의 변경사항을 잠시 저장하는 버퍼
    * WAL 버퍼내에 저장된 내용은 정해진 시점에 WAL 파일로 저장

### 프로세스 유형

<img src="https://private-user-images.githubusercontent.com/91363333/383144288-c040868e-e7d0-4fd3-9d16-db2b51b554bd.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzA4MDk5MjYsIm5iZiI6MTczMDgwOTYyNiwicGF0aCI6Ii85MTM2MzMzMy8zODMxNDQyODgtYzA0MDg2OGUtZTdkMC00ZmQzLTlkMTYtZGIyYjUxYjU1NGJkLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNDExMDUlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjQxMTA1VDEyMjcwNlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWIxNmM3ZGFjYjkyZWY3MzJjNzFhMzg2OWI0NDA2YTgwMWM2YmIyZjljYTE1MjljYTBlNDUzMjgyZDVlZTE1NzgmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.6MR3XLQZbVrcKnyU2k3UIJe4asU_wDBCbgQLhk-B54w" alt="postgresql2" style="max-width: 100%;">

* Postmaster(Daemon) 프로세스
  * PostgreSQL 를 기동할때 가장 먼저 시작되는 프로세스, 초기 기동시 복구작업
  * shared 메모리 초기화 작업, 백그라운드 프로세스 구동작업 수행
  * 클라이언트 프로세스의 접속 요청이 있을때 Backend 프로세스를 생성
  * ptree 명령어로 프로세스간의 명령어를 확인하면 Postmaster 프로세스가 가장 상위에 위치
* Background 프로세스
  * logger : 에러메시지를 로그파일에 기록
  * checkpointer : 체크포인트 발생시 dirty 버퍼를 파일에 기록
  * writer : 주기적으로 dirty 버퍼를 파일에 기록
  * wal writer : WAL 버퍼 내용을 WAL 파일에 기록
  * autovacuum launcher : vacuum 이 필요한 시점에 autovacuum worker 를 fork
  * archiver : archive 모드일때 WAL 파일을 지정된 디렉토리에 복사
  * stats collector : 세션수행정보(pg_stat_activity)와 테이블 사용 통계 정보(pg_stat_all_tables)과 같은 DBMS 사용 통계정보 수집
* Backend 프로세스
  * max_connections 설정값에 따라 생성 기본 100개
  * 사용자 프로새스의 쿼리 요청을 수행한후 결과 전송
  * 쿼리 수행에 필요한 몇가지 메모리구조가 필요 이를 로컬 메모리 라고 함
    * work_mem : 정렬, bitmap 작업, 해시조인, merge 조인등 작업시 사용되는 공간, 기본설정 4MB
    * maintenance_work_mem : vacuum, index 생성 등 사용되는 공간 기본설정 64MB
    * temp_buffers : temporary 테이블을 저장하기 위한 공간 기본 설정 8MB
* Client 프로세스