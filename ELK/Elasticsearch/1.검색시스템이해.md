
## 검색시스템 이해

* 검색엔진
  * 웹에서 정보를 수집해 검색 결과를 제공하는 프로그램, 검색 엔진은 제공되는 데이터의 특성에 따라 구현 형태가 달라짐
* 검색 시스템
  * 대용량 데이터를 기반으로 신뢰성 있는 검색 결과를 제공하기 위해 검색 엔진을 기반으로 구축된 시스템을 통칭
  * 수집기를 이용해 방대한 데이터를 수집하고 이를 다수의 검색엔진을 이용해 색인하고 검색결과를 제공
* 검색 서비스
  * 검색엔진을 기반으로 구축한 검색시스템을 활용해 검색 결과를 서비스로 제공
* `검색 서비스 > 검색 시스템 > 검색 엔진`
* Elasticsearch 는 검색엔진을 기반으로 검색시스템을 구축하는데 사용되는 오픈소스 검색엔진

### 검색 시스템의 구성 요소

* 데이터 수집기
  * 웹사이트, 블로그, 카페 등 웹에서 필요한 정보르 수집하는 프로그램
  * 크롤러, 스파이터, 웜, 웹로봇 등으로 불림
  * 파일, 데이터베이스, 웹페이지 등 웹상의 대부분의 정보를 대상
* 데이터 스토리지
  * 데이터 베이스에서 데이터를 저장하는 물리적인 장소
  * 색인한 데이터를 보관
* 데이터 변환 색인기
  * 데이터를 검색 가능한 구조로 가공하고 저장하게 도와주는 프로그램
  * 다양한 형태소 분석기를 조합해 정보에서 의미있는 용어를 추출
  * 검색에 유리한 역색인 구조로 데이터 저장
* 데이터 검색기
  * 사용자의 질의를 입력받아 일치하는 결과로 반환
  * 질의와 문서가 일치하는지 유사도 기반의 검색 순위 알고리즘으로 판단.

#### RDBMS 와 Elasticsearch 비교

* SQL 은 텍스트 매칭을 통한 단순한 검색만 가능
* 검색엔진은 비정형 데이터를 색인하고 검색 가능, 형태소 분석을 통해 사람이 구사하는 자연어의 처리가 가능해진다.
* 엘라스틱서치는 구조화 되지 않은 데이터까지 스스로 분석해 자동으로 필드를 생성하고 저장가능
* 역색인 되는 문자열 전체를 정책에 따라 소문자 혹은 대문자로 생성하고 쿼리가 들어오는 필터를 색인 시간과 검색시간에 동일하지 지정하면 어떤 문자열이 들어와도 검색가능

| 엘라스틱서치  | RDBMS  |
|:-------:|:------:|
| 인덱스  | 데이터베이스  |
|샤드|파티션|
|타입|테이블|
|문서|레코드|
|필드|컬럼|
|매핑|스키마|
|Query DSL|SQL|

* 엘라스틱서치는 HTTP 를 통해 JSON 형태의 데이터를 주고 받는 RESTful API 를 제공
* 엘라스틱 서치는 자바,Apache Lucene 기반으로 만들어진 오픈소스 검색엔진

|엘라스틱서치 HTTP 메소드 |   기능   |  SQL   |
|:-------:|:------:|:------:|
|GET| 데이터 조회 | SELECT |
|PUT| 데이터 추가 | INSERT |
|POST| 데이터 수정 | UPDATE |
|DELETE| 데이터 삭제 | DELETE |
|HEAD| 헤더 정보 조회 |   -    |

* `curl -X(메소드) http://host:port/(인덱스)/(타입)/(문서 id) -d '{JSON 데이터}'`
* `SELECT * FROM USER WHERE Name like %가마돈%`
* `GET http://localhost:9200/user/_search?q=name:가마돈`

### 엘라스틱서치 장점

* Full Text Search
  * 내용전체를 색인해 특정단어가 포함되었는지 검색
* 통계 분석
  * 키바나와 연결하여 실시간으로 쌓이는 로그 분석 시각화
* 스키마리스
  * 데이터베이스의 스키마라는 구조가 없어 정형화 되지 않은 문서도 자동으로 색인하고 검색 가능
* RESTful APL
  * HTTP 를 통해 JSON 형태의 데이터를 주고 받아서 개발언어, 운영체제, 시스템에 관계없이 이기종 플랫폼에서도 이용가능
* 멀티테넨시
  * 상이한 인덱스도 필드명이 같으면 인덱스를 한번에 조회할수 있다.
* Document-Oriented
  * 여러 계층 데이터를 JSON 형식의 구조화된 문서로 인덱스에 저장할수 있다, 계층 구조로 문서도 한번에 쿼리로 쉽게 조회 가능
* 역색인
  * 루씬 기반 검색엔진으로 역색인 지원
  * MongoDB, 카산드라는 역색인 지원 x
* 확장성, 가용성
  * 분산환경에서 샤드라는 작은 단위로 나눠 제공하여 데이터의 종류와 성격에 따라 데이터를 분산해서 빠르게 처리가능

### 엘라스틱서치 단점

* 실시간이 아님
  * 색인된 데이터는 1초뒤에나 검색 가능
  * 내부적으로 커밋과 플러시 같은 과정을거치기 때문에 준 실시간 이다
* 트랜잭션과 롤백 기능이 없다
  * 기본적으로 분산시스템으로 구성되어 전체적인 클러스터 성능향상을 위해 시스템으로 비용소모가 큰 롤백과 트랜잭션을 지원하지 않는다
  * 최악의 경우 데이터 손실 위험
* 데이터 업데이트 제공하지 않음
  * 업데이트 명령이 요청될경우 기존 문서를 삭제하고 변경된 내용으로 새로운 문서를 생성
  * 단순 업데이트에 비해서 상대적 많은 비용 발생

### 환경 구축

* 엘라스틱서치 노드 하나만 구성된 클러스터를 싱글 모드 또는 테스트 모드 라고 부른다
* 실제 운영서비스를 구축할경우 최소 3개이상의 물리적 노드로 클러스터 구성을 권장
* 엘라스틱서치는 자바로 개발되었기때문에 자바런타임이 필요
* docker-compose 후 스냅샷 파일 볼륨마운트, 파일 스냅샷

```
curl -XPUT "http://localhost:9200/_snapshot/javacafe" -H "Content-Type: application/json" -d '{
  "type": "fs",
  "settings": {
    "location": "/es/book_backup/search_example",
    "compress": true
  }
}'

curl -XGET 'localhost:9200/_snapshot/javacafe/_all'

{
  "snapshots":[
    {
      "snapshot":"movie-search",
      "uuid":"Kz5k4fusS7KBZy55wLeZ0Q",
      "version_id":6040399,
      "version":"6.4.3",
      "indices":[
        "movie_search"
      ],
      "include_global_state":false,
      "state":"SUCCESS",
      "start_time":"2019-03-23T16:01:04.910Z",
      "start_time_in_millis":1553356864910,
      "end_time":"2019-03-23T16:01:05.342Z",
      "end_time_in_millis":1553356865342,
      "duration_in_millis":432,
      "failures":[ ],
      "shards":{
        "total":5,
        "failed":0,
        "successful":5
      }
    }
  ]
}
```

### 엘라스틱서치 설정 주요항목

* cluster.name
  * 클러스터 이름
* node.name
  * 노드 이름
  * 기본적으로 엘라스틱서치 하위 data 디렉토리에 인덱스 생성
* path.log
  * 로그파일 경로
  * /path/to/logs 가 기본경로
* path.repo
  * 스냅샷 저장경로
* network.host
  * 특정 IP 허용
* http.port
  * HTTP 포트 9200
* transport.tcp.port
  * 엘라스틱 서치 클라이언트 접근 포트 9300
* discovery.zen.ping.unicast.hosts
  * 노드가 여러개일경우 유니캐스트로 활성화된 다른 서버 찾음
* discovery.zen.minimum_master_nodes
  * 마스터 노드 선출을 위한 노드수
* node.master
  * 마스터 노드로 설정
* node.data
  * 데이터 노드로 설정